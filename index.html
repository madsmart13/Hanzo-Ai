<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<title>Hanzo AI</title>
<style>
body {
  margin: 0;
  background: #05060a;
  color: #fff;
  font-family: sans-serif;
  display: flex;
  height: 100vh;
  overflow: hidden;
}
#scene {
  width: 55%;
  height: 100%;
}
#chatBox {
  width: 45%;
  display: flex;
  flex-direction: column;
  background: rgba(20, 10, 40, 0.7);
  padding: 20px;
}
#messages {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 10px;
}
.msg {
  margin: 5px 0;
  padding: 10px 14px;
  border-radius: 12px;
  max-width: 80%;
  line-height: 1.5;
}
.msg.user { background: #5d2bff; align-self: flex-end; }
.msg.ai { background: #1a1a2b; border: 1px solid #6b42ff; }
#inputArea {
  display: flex;
}
#inp {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  color: #fff;
  outline: none;
}
#send {
  margin-left: 5px;
  padding: 10px 15px;
  background: #7b46ff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
</style>
</head>
<body>
<div id="scene"></div>
<div id="chatBox">
  <div id="messages"></div>
  <div id="inputArea">
    <input id="inp" placeholder="پیامت رو بنویس..." />
    <button id="send">ارسال</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.14.0/dist/gsap.min.js"></script>
<script>
// --------------------  HANZO 3D  --------------------
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, (window.innerWidth*0.55)/window.innerHeight, 0.1, 1000);
camera.position.set(0,0,4);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth*0.55, window.innerHeight);
document.getElementById("scene").appendChild(renderer.domElement);

const sphereGeo = new THREE.SphereGeometry(1, 64, 64);
const sphereMat = new THREE.MeshStandardMaterial({ color:0x5533ff, metalness:0.6, roughness:0.2 });
const hanzo = new THREE.Mesh(sphereGeo, sphereMat);
scene.add(hanzo);

const light = new THREE.PointLight(0x8844ff, 2, 20);
light.position.set(2,2,3);
scene.add(light);

function animate() {
  requestAnimationFrame(animate);
  hanzo.rotation.y += 0.003;
  renderer.render(scene, camera);
}
animate();

function pulse() {
  gsap.fromTo(hanzo.scale, {x:1,y:1,z:1}, {x:1.15,y:1.15,z:1.15, duration:0.4, yoyo:true, repeat:1});
}

// --------------------  CHAT / STREAM  --------------------
const messages = document.getElementById("messages");
const inp = document.getElementById("inp");
const send = document.getElementById("send");

// جای کلید API — اینجا کلید را بگذار
const OPENAI_KEY = "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";

async function askHanzo(text) {
  const userMsg = document.createElement("div");
  userMsg.className = "msg user";
  userMsg.textContent = text;
  messages.appendChild(userMsg);
  messages.scrollTop = messages.scrollHeight;

  pulse();

  const aiMsg = document.createElement("div");
  aiMsg.className = "msg ai";
  messages.appendChild(aiMsg);

  const response = await fetch("https://api.openai.com/v1/responses", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${OPENAI_KEY}`
    },
    body: JSON.stringify({
      model: "gpt-4.1-mini",
      input: text,
      stream: true
    })
  });

  const reader = response.body.getReader();
  const decoder = new TextDecoder();

  aiMsg.textContent = "";

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value);

    chunk.split("\n").forEach(line => {
      if (line.startsWith("data:")) {
        try {
          const json = JSON.parse(line.replace("data:", ""));
          if (json.output_text) {
            aiMsg.textContent += json.output_text;
            messages.scrollTop = messages.scrollHeight;
          }
        } catch {}
      }
    });
  }
}

send.onclick = () => {
  const v = inp.value.trim();
  if (!v) return;
  inp.value = "";
  askHanzo(v);
};

</script>
</body>
</html>
