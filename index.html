<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hanzo AI 3D Chat</title>
<style>
body{margin:0;height:100vh;display:flex;background:#05060a;color:#fff;font-family:sans-serif;}
#sceneContainer{width:55%;height:100%;background:radial-gradient(circle,#0a0a16,#000);}
#chatContainer{width:45%;height:100%;display:flex;flex-direction:column;padding:20px;background:rgba(20,10,40,0.7);backdrop-filter:blur(10px);border-left:2px solid rgba(120,60,255,0.3);}
#messages{flex:1;overflow-y:auto;padding-right:10px;}
.msg{margin:8px 0;padding:10px 14px;border-radius:12px;max-width:85%;line-height:1.5;font-size:15px;}
.msg.user{background:#5d2bff;margin-left:auto;}
.msg.ai{background:#1a1a2b;border:1px solid #6b42ff;}
#inputBox{display:flex;margin-top:12px;}
#userInput{flex:1;padding:12px;border-radius:10px;border:none;outline:none;font-size:15px;background:rgba(255,255,255,0.1);color:#fff;}
#sendBtn{padding:12px 18px;margin-left:10px;border:none;border-radius:10px;background:#7b46ff;cursor:pointer;color:#fff;font-weight:bold;transition:0.2s;}
#sendBtn:hover{background:#9e6dff;}
</style>
</head>
<body>

<div id="sceneContainer"></div>
<div id="chatContainer">
    <div id="messages"></div>
    <div id="inputBox">
        <input id="userInput" placeholder="پیامت رو بنویس..." />
        <button id="sendBtn">Send</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.14.0/dist/gsap.min.js"></script>

<script>
// ------------------------- 3D Scene ------------------------------
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth*0.55/window.innerHeight,0.1,1000);
camera.position.set(0,0,4);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth*0.55,window.innerHeight);
document.getElementById("sceneContainer").appendChild(renderer.domElement);
const controls = new THREE.OrbitControls(camera,renderer.domElement);
controls.enableZoom=false;controls.enablePan=false;controls.autoRotate=true;controls.autoRotateSpeed=1;

// Hanzo Sphere
const geo = new THREE.SphereGeometry(1,64,64);
const mat = new THREE.MeshStandardMaterial({color:0x7b46ff,roughness:0.3,metalness:0.7});
const hanzo = new THREE.Mesh(geo,mat);
scene.add(hanzo);

// Lights
scene.add(new THREE.AmbientLight(0xffffff,0.4));
const dir = new THREE.DirectionalLight(0xffffff,1); dir.position.set(3,2,5); scene.add(dir);

function animate(){
    requestAnimationFrame(animate);
    hanzo.rotation.y+=0.005;
    controls.update();
    renderer.render(scene,camera);
}
animate();
</script>

<script>
// ------------------------- Chat + Streaming -----------------------
window.addEventListener("DOMContentLoaded",()=>{
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const messages = document.getElementById("messages");

    function addMessage(sender,text){
        const msg=document.createElement("div");
        msg.className="msg "+sender;
        msg.textContent=text;
        messages.appendChild(msg);
        messages.scrollTop=messages.scrollHeight;
        return msg;
    }

    async function sendMessage(){
        const text=input.value.trim();
        if(!text) return;
        addMessage("user",text);
        input.value="";
        const aiMsg = addMessage("ai","");

        // Hanzo animation: pulse & rotate faster
        gsap.to(hanzo.scale,{x:1.1,y:1.1,z:1.1,duration:0.3,yoyo:true,repeat:1});
        gsap.to(hanzo.rotation,{y:hanzo.rotation.y+0.2,duration:0.3});

        const response = await fetch("http://localhost:3000/api/hanzo",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({message:text})
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while(true){
            const {done,value}=await reader.read();
            if(done) break;

            const chunk = decoder.decode(value);
            try{
                const lines = chunk.split("\n");
                for(const line of lines){
                    if(!line.trim().startsWith("data:")) continue;
                    const json = line.replace("data:","").trim();
                    if(json==="[DONE]") continue;
                    const parsed = JSON.parse(json);
                    const txt = parsed.output_text || parsed.delta || "";
                    if(txt) aiMsg.textContent += txt;

                    // Pulse Hanzo with streaming
                    gsap.to(hanzo.scale,{x:1.05,y:1.05,z:1.05,duration:0.2,yoyo:true,repeat:1});
                }
            }catch(e){console.error(e);}
            messages.scrollTop=messages.scrollHeight;
        }
    }

    sendBtn.addEventListener("click",sendMessage);
    input.addEventListener("keydown",(e)=>{if(e.key==="Enter"){e.preventDefault();sendMessage();}});
});
</script>

</body>
</html>
